var Je=Object.defineProperty;var Xe=(t,e,n)=>e in t?Je(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var ke=(t,e,n)=>Xe(t,typeof e!="symbol"?e+"":e,n);import{a as A,t as I,c as Ee}from"../chunks/disclose-version.DJaJJ7WK.js";import{i as be}from"../chunks/legacy.H8ha-IAe.js";import{m as K,M as pe,a5 as Qe,a4 as $e,J as et,i as tt,I as nt,al as Ce,K as rt,L as De,N as Se,o as ue,ah as st,as as ge,O as Fe,j as We,P as at,F as Me,at as it,au as ot,ak as ct,av as lt,k as ut,a9 as _t,a2 as dt,A as ze,aw as ft,ax as vt,ay as gt,af as bt,az as wt,aA as ht,H as mt,aB as yt,aC as pt,b as St,ao as At,p as we,v as x,g as i,w as m,t as G,x as R,s as he,C as y,aD as O,q as ie}from"../chunks/runtime.DD4oRMrK.js";import{a as xt,l as Et,s as ne,e as q}from"../chunks/render.BcBaRd89.js";import{p as P,i as Y}from"../chunks/props.Dab2Uh7G.js";import{a as Tt,o as qe}from"../chunks/index-client.ByK61EDX.js";function oe(t,e){return e}function It(t,e,n,r){for(var s=[],c=e.length,u=0;u<c;u++)ot(e[u].e,s,!0);var f=c>0&&s.length===0&&n!==null;if(f){var S=n.parentNode;ct(S),S.append(n),r.clear(),te(t,e[0].prev,e[c-1].next)}lt(s,()=>{for(var E=0;E<c;E++){var w=e[E];f||(r.delete(w.k),te(t,w.prev,w.next)),ut(w.e,!f)}})}function ce(t,e,n,r,s,c=null){var u=t,f={flags:e,items:new Map,first:null};{var S=t;u=K?pe(Qe(S)):S.appendChild($e())}K&&et();var E=null,w=!1;tt(()=>{var _=n(),b=nt(_)?_:_==null?[]:Ce(_),v=b.length;if(w&&v===0)return;w=v===0;let g=!1;if(K){var k=u.data===rt;k!==(v===0)&&(u=De(),pe(u),Se(!1),g=!0)}if(K){for(var N=null,U,h=0;h<v;h++){if(ue.nodeType===8&&ue.data===st){u=ue,g=!0,Se(!1);break}var M=b[h],J=r(M,h);U=Ve(ue,f,N,null,M,J,h,s,e),f.items.set(J,U),N=U}v>0&&pe(De())}if(!K){var C=_t;Ut(b,f,u,s,e,(C.f&ge)!==0,r)}c!==null&&(v===0?E?Fe(E):E=We(()=>c(u)):E!==null&&at(E,()=>{E=null})),g&&Se(!0),n()}),K&&(u=ue)}function Ut(t,e,n,r,s,c,u,f){var S=t.length,E=e.items,w=e.first,_=w,b,v=null,g=[],k=[],N,U,h,M;for(M=0;M<S;M+=1){if(N=t[M],U=u(N,M),h=E.get(U),h===void 0){var J=_?_.e.nodes_start:n;v=Ve(J,e,v,v===null?e.first:v.next,N,U,M,r,s),E.set(U,v),g=[],k=[],_=v.next;continue}if(kt(h,N,M),h.e.f&ge&&Fe(h.e),h!==_){if(b!==void 0&&b.has(h)){if(g.length<k.length){var C=k[0],F;v=C.prev;var X=g[0],Z=g[g.length-1];for(F=0;F<g.length;F+=1)Ne(g[F],C,n);for(F=0;F<k.length;F+=1)b.delete(k[F]);te(e,X.prev,Z.next),te(e,v,X),te(e,Z,C),_=C,v=Z,M-=1,g=[],k=[]}else b.delete(h),Ne(h,_,n),te(e,h.prev,h.next),te(e,h,v===null?e.first:v.next),te(e,v,h),v=h;continue}for(g=[],k=[];_!==null&&_.k!==U;)(c||!(_.e.f&ge))&&(b??(b=new Set)).add(_),k.push(_),_=_.next;if(_===null)continue;h=_}g.push(h),v=h,_=h.next}if(_!==null||b!==void 0){for(var a=b===void 0?[]:Ce(b);_!==null;)(c||!(_.e.f&ge))&&a.push(_),_=_.next;var o=a.length;if(o>0){var d=S===0?n:null;It(e,a,d,E)}}Me.first=e.first&&e.first.e,Me.last=v&&v.e}function kt(t,e,n,r){it(t.v,e),t.i=n}function Ve(t,e,n,r,s,c,u,f,S,E){var w=(S&vt)!==0,_=(S&gt)===0,b=w?_?dt(s):ze(s):s,v=S&ft?ze(u):u,g={i:v,v:b,k:c,a:null,e:null,prev:n,next:r};try{return g.e=We(()=>f(t,b,v),K),g.e.prev=n&&n.e,g.e.next=r&&r.e,n===null?e.first=g:(n.next=g,n.e.next=g.e),r!==null&&(r.prev=g,r.e.prev=g.e),g}finally{}}function Ne(t,e,n){for(var r=t.next?t.next.e.nodes_start:n,s=e?e.e.nodes_start:n,c=t.e.nodes_start;c!==r;){var u=bt(c);s.before(c),c=u}}function te(t,e,n){e===null?t.first=n:(e.next=n,e.e.next=n&&n.e),n!==null&&(n.prev=e,n.e.prev=e&&e.e)}function je(t){if(K){var e=!1,n=()=>{if(!e){if(e=!0,t.hasAttribute("value")){var r=t.value;ae(t,"value",null),t.value=r}if(t.hasAttribute("checked")){var s=t.checked;ae(t,"checked",null),t.checked=s}}};t.__on_r=n,wt(n),xt()}}function ae(t,e,n,r){var s=t.__attributes??(t.__attributes={});K&&(s[e]=t.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&t.nodeName==="LINK")||s[e]!==(s[e]=n)&&(e==="style"&&"__styles"in t&&(t.__styles={}),e==="loading"&&(t[ht]=n),n==null?t.removeAttribute(e):typeof n!="string"&&Dt(t).includes(e)?t[e]=n:t.setAttribute(e,n))}var Be=new Map;function Dt(t){var e=Be.get(t.nodeName);if(e)return e;Be.set(t.nodeName,e=[]);for(var n,r=t,s=Element.prototype;s!==r;){n=yt(r);for(var c in n)n[c].set&&e.push(c);r=mt(r)}return e}function Te(t,e,n){var r=t.__className,s=Mt(e);K&&t.className===s?t.__className=s:(r!==s||K&&t.className!==s)&&(e==null&&!n?t.removeAttribute("class"):t.className=s,t.__className=s)}function Mt(t,e){return(t??"")+""}function zt(t,e,n){if(n){if(t.classList.contains(e))return;t.classList.add(e)}else{if(!t.classList.contains(e))return;t.classList.remove(e)}}function Ge(t,e,n=e){var r=pt();Et(t,"input",s=>{var c=s?t.defaultValue:t.value;if(c=Ae(t)?xe(c):c,n(c),r&&c!==(c=e())){var u=t.selectionStart,f=t.selectionEnd;t.value=c??"",f!==null&&(t.selectionStart=u,t.selectionEnd=Math.min(f,t.value.length))}}),(K&&t.defaultValue!==t.value||St(e)==null&&t.value)&&n(Ae(t)?xe(t.value):t.value),At(()=>{var s=e();Ae(t)&&s===xe(t.value)||t.type==="date"&&!s&&!t.value||s!==t.value&&(t.value=s??"")})}function Ae(t){var e=t.type;return e==="number"||e==="range"}function xe(t){return t===""?null:+t}const Nt=!0,kn=Object.freeze(Object.defineProperty({__proto__:null,prerender:Nt},Symbol.toStringTag,{value:"Module"}));class Bt{constructor(){ke(this,"db",null)}async init(){return new Promise((e,n)=>{const r=indexedDB.open("UserData",1);r.onupgradeneeded=()=>{this.db=r.result,this.db.objectStoreNames.contains("userSessions")||this.db.createObjectStore("userSessions")},r.onsuccess=()=>{this.db=r.result,e()},r.onerror=()=>{console.error("Error opening IndexedDB:",r.error),n(r.error)}})}async saveSession(e,n){if(!this.db)throw new Error("Database is not initialized.");const r=this.db.transaction("userSessions","readwrite"),s=r.objectStore("userSessions");return new Promise((c,u)=>{s.put(n,e.toString()),r.oncomplete=()=>{console.log(`Session saved for user: ${e}`),c()},r.onerror=()=>{console.error("Error saving session:",r.error),u(r.error)}})}async getSession(e){if(!this.db)throw new Error("Database is not initialized.");const r=this.db.transaction("userSessions","readonly").objectStore("userSessions");return new Promise((s,c)=>{const u=r.get(e.toString());u.onsuccess=()=>{s(u.result||null)},u.onerror=()=>{console.error("Error loading session:",u.error),c(u.error)}})}async deleteSession(e){if(!this.db)throw new Error("Database is not initialized.");const n=this.db.transaction("userSessions","readwrite"),r=n.objectStore("userSessions");return new Promise((s,c)=>{r.delete(e.toString()),n.oncomplete=()=>{console.log(`Session deleted for user: ${e}`),s()},n.onerror=()=>{console.error("Error deleting session:",n.error),c(n.error)}})}async sessionExists(e){return await this.getSession(e)!==null}getDB(){if(!this.db)throw new Error("Database is not initialized");return this.db}}const _e=new Bt;typeof window<"u"&&(window.initDB=()=>_e.init(),window.saveUserSession=(t,e)=>{const n=e.buffer;return _e.saveSession(t,n)},window.getUserSession=t=>_e.getSession(t),window.deleteUserSession=t=>_e.deleteSession(t),window.checkSessionExists=t=>_e.sessionExists(t));let T;function de(t){const e=T.__externref_table_alloc();return T.__wbindgen_export_2.set(e,t),e}function Oe(t,e){try{return t.apply(this,e)}catch(n){const r=de(n);T.__wbindgen_exn_store(r)}}const Ye=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&Ye.decode();let fe=null;function Ie(){return(fe===null||fe.byteLength===0)&&(fe=new Uint8Array(T.memory.buffer)),fe}function Le(t,e){return t=t>>>0,Ye.decode(Ie().subarray(t,t+e))}function ve(t){return t==null}const Re=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>{T.__wbindgen_export_3.get(t.dtor)(t.a,t.b)});function Ot(t,e,n,r){const s={a:t,b:e,cnt:1,dtor:n},c=(...u)=>{s.cnt++;const f=s.a;s.a=0;try{return r(f,s.b,...u)}finally{--s.cnt===0?(T.__wbindgen_export_3.get(s.dtor)(f,s.b),Re.unregister(s)):s.a=f}};return c.original=s,Re.register(c,s,s),c}function Lt(t,e){return t=t>>>0,Ie().subarray(t/1,t/1+e)}let He=0;function Rt(t,e){const n=e(t.length*1,1)>>>0;return Ie().set(t,n/1),He=t.length,n}function Pt(t,e,n){T.closure20_externref_shim(t,e,n)}function Ct(t,e,n,r){T.closure41_externref_shim(t,e,n,r)}const Pe=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>T.__wbg_sessionmanager_free(t>>>0,1));class Ft{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Pe.unregister(this),e}free(){const e=this.__destroy_into_raw();T.__wbg_sessionmanager_free(e,0)}constructor(){const e=T.sessionmanager_new();return this.__wbg_ptr=e>>>0,Pe.register(this,this.__wbg_ptr,this),this}initialize(){return T.sessionmanager_initialize(this.__wbg_ptr)}save_session(e,n){const r=Rt(n,T.__wbindgen_malloc),s=He;return T.sessionmanager_save_session(this.__wbg_ptr,e,r,s)}get_session(e){return T.sessionmanager_get_session(this.__wbg_ptr,e)}delete_session(e){return T.sessionmanager_delete_session(this.__wbg_ptr,e)}session_exists(e){return T.sessionmanager_session_exists(this.__wbg_ptr,e)}}async function Wt(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(r){if(t.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function qt(){const t={};return t.wbg={},t.wbg.__wbg_buffer_61b7ce01341d7f88=function(e){return e.buffer},t.wbg.__wbg_call_500db948e69c7330=function(){return Oe(function(e,n,r){return e.call(n,r)},arguments)},t.wbg.__wbg_call_b0d8e36992d9900d=function(){return Oe(function(e,n){return e.call(n)},arguments)},t.wbg.__wbg_checkSessionExists_340e16b697e915bf=function(e){return checkSessionExists(BigInt.asUintN(64,e))},t.wbg.__wbg_deleteUserSession_36cd7b326cd4514a=function(e){return deleteUserSession(BigInt.asUintN(64,e))},t.wbg.__wbg_getUserSession_e0f134950e9904c6=function(e){return getUserSession(BigInt.asUintN(64,e))},t.wbg.__wbg_initDB_5ef5f7eaea3713b7=function(){return initDB()},t.wbg.__wbg_length_65d1cd11729ced11=function(e){return e.length},t.wbg.__wbg_new_3d446df9155128ef=function(e,n){try{var r={a:e,b:n},s=(u,f)=>{const S=r.a;r.a=0;try{return Ct(S,r.b,u,f)}finally{r.a=S}};return new Promise(s)}finally{r.a=r.b=0}},t.wbg.__wbg_new_3ff5b33b1ce712df=function(e){return new Uint8Array(e)},t.wbg.__wbg_newnoargs_fd9e4bf8be2bc16d=function(e,n){return new Function(Le(e,n))},t.wbg.__wbg_newwithbyteoffsetandlength_ba35896968751d91=function(e,n,r){return new Uint8Array(e,n>>>0,r>>>0)},t.wbg.__wbg_newwithlength_34ce8f1051e74449=function(e){return new Uint8Array(e>>>0)},t.wbg.__wbg_queueMicrotask_2181040e064c0dc8=function(e){queueMicrotask(e)},t.wbg.__wbg_queueMicrotask_ef9ac43769cbcc4f=function(e){return e.queueMicrotask},t.wbg.__wbg_resolve_0bf7c44d641804f9=function(e){return Promise.resolve(e)},t.wbg.__wbg_saveUserSession_0686280def1dddff=function(e,n){return saveUserSession(BigInt.asUintN(64,e),n)},t.wbg.__wbg_set_23d69db4e5c66a6e=function(e,n,r){e.set(n,r>>>0)},t.wbg.__wbg_static_accessor_GLOBAL_0be7472e492ad3e3=function(){const e=typeof global>"u"?null:global;return ve(e)?0:de(e)},t.wbg.__wbg_static_accessor_GLOBAL_THIS_1a6eb482d12c9bfb=function(){const e=typeof globalThis>"u"?null:globalThis;return ve(e)?0:de(e)},t.wbg.__wbg_static_accessor_SELF_1dc398a895c82351=function(){const e=typeof self>"u"?null:self;return ve(e)?0:de(e)},t.wbg.__wbg_static_accessor_WINDOW_ae1c80c7eea8d64a=function(){const e=typeof window>"u"?null:window;return ve(e)?0:de(e)},t.wbg.__wbg_then_0438fad860fe38e1=function(e,n){return e.then(n)},t.wbg.__wbg_then_0ffafeddf0e182a4=function(e,n,r){return e.then(n,r)},t.wbg.__wbindgen_boolean_get=function(e){const n=e;return typeof n=="boolean"?n?1:0:2},t.wbg.__wbindgen_cb_drop=function(e){const n=e.original;return n.cnt--==1?(n.a=0,!0):!1},t.wbg.__wbindgen_closure_wrapper80=function(e,n,r){return Ot(e,n,21,Pt)},t.wbg.__wbindgen_init_externref_table=function(){const e=T.__wbindgen_export_2,n=e.grow(4);e.set(0,void 0),e.set(n+0,void 0),e.set(n+1,null),e.set(n+2,!0),e.set(n+3,!1)},t.wbg.__wbindgen_is_function=function(e){return typeof e=="function"},t.wbg.__wbindgen_is_null=function(e){return e===null},t.wbg.__wbindgen_is_undefined=function(e){return e===void 0},t.wbg.__wbindgen_memory=function(){return T.memory},t.wbg.__wbindgen_throw=function(e,n){throw new Error(Le(e,n))},t.wbg.__wbindgen_uint8_array_new=function(e,n){var r=Lt(e,n).slice();return T.__wbindgen_free(e,n*1,1),r},t}function Vt(t,e){return T=t.exports,Ke.__wbindgen_wasm_module=e,fe=null,T.__wbindgen_start(),T}async function Ke(t){if(T!==void 0)return T;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof t>"u"&&(t=new URL(""+new URL("../assets/wizard_pi_wasm_bg.CxENxoTU.wasm",import.meta.url).href,import.meta.url));const e=qt();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:r}=await Wt(await t,e);return Vt(n,r)}const le=async t=>{console.log("Sending request payload to server:",t);const e={...t,session_data:Array.from(new Uint8Array(t.session_data))},n=await fetch("https://v3.spb.ru/wizard_pi_user_action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(console.log("Server response status:",n.status),!n.ok)throw new Error("Network Error");const r=await n.json();return console.log("Server response data:",r),r};var me=(t=>(t.MINI_APP_INITIALIZED="MINI_APP_INITIALIZED",t.LOGIN_START="LOGIN_START",t.SIGN_OUT="SIGN_OUT",t))(me||{}),re=(t=>(t.TwoFAPassRequest="TwoFAPassRequest",t.AuthSuccess="AuthSuccess",t.AuthError="AuthError",t.SignedOut="SignedOut",t.MiniAppInitConfirmed="MiniAppInitConfirmed",t))(re||{}),jt=I('<div class="audio-message"><audio controls>Your browser does not support the audio element.</audio> <div class="message-text"> </div></div>'),Gt=I('<div class="message-text"> </div>'),Yt=I('<div class="message server-message"><!></div>'),Ht=I('<div class="message user-message"><div class="message-text"> </div> <img alt="User" class="avatar"></div>'),Kt=I("<div><!></div>"),Zt=I('<div class="input-container"><input type="text" placeholder="Type your message..."> <button>SEND</button></div>'),Jt=I('<button class="response-button"> </button>'),Xt=I('<div class="buttons-container"></div>'),Qt=I('<button class="action-button"> </button>'),$t=I('<div class="action-buttons-container"></div>'),en=I('<div class="container"><div class="messages-container"></div> <!> <!> <!></div>');function tn(t,e){we(e,!1);let n=P(e,"user",8),r=P(e,"avatarUrl",12),s=P(e,"buttons",12),c=P(e,"actionButtons",12),u=P(e,"canInput",12),f=P(e,"sessionData",8),S=P(e,"sessionManager",8),E=P(e,"onSignOut",8),w=P(e,"messages",12),_=[],b=O("");const v=new ArrayBuffer(0);async function g(){if(i(b).trim()){w([...w(),{type:"user",text:i(b)}]);try{const a=await le({user_id:n().id,username:n().username,user_first_name:n().first_name,user_last_name:n().last_name,action:i(b),session_data:f()||v});w([...w(),{type:"server",text:a.message}]),s(a.buttons),c(a.action_buttons),u(a.can_input),r(r()),y(b,"")}catch(a){console.error("Error sending message:",a),w([...w(),{type:"server",text:"Error sending message to server"}])}}}async function k(a){try{const o=a==="Sign out"?{user_id:n().id,username:n().username,user_first_name:n().first_name,user_last_name:n().last_name,action_step:me.SIGN_OUT,session_data:f()||v}:{user_id:n().id,username:n().username,user_first_name:n().first_name,user_last_name:n().last_name,action:a,session_data:f()||v},d=await le(o);if(w([...w(),{type:"user",text:a},{type:"server",text:d.message,audioData:d.audio_data}]),s(d.buttons),c(d.action_buttons),u(d.can_input),d.stage===re.SignedOut)try{await S().session_exists(BigInt(n().id))&&(await S().delete_session(BigInt(n().id)),console.log("Session successfully deleted after sign-out command from user"),E()())}catch(p){console.error("Error handling session deletion after sign-out command from user:",p)}}catch(o){console.error("Error handling button click:",o)}}function N(a){try{const o=new Uint8Array(a),d=new Blob([o.buffer],{type:"audio/mpeg"}),p=URL.createObjectURL(d);return _.push(p),console.log("Audio URL created:",p),console.log("Audio data size:",o.length),p}catch(o){return console.error("Error creating audio URL:",o),""}}Tt(()=>{_.forEach(a=>URL.revokeObjectURL(a))}),be();var U=en(),h=x(U);ce(h,5,w,oe,(a,o)=>{var d=Kt(),p=x(d);{var l=V=>{var W=Yt(),D=x(W);{var L=j=>{var B=jt(),se=x(B);G(()=>ae(se,"src",N(i(o).audioData)));var Q=R(se,2),$=x(Q,!0);m(Q),m(B),G(()=>ne($,i(o).text)),q("error",se,ee=>console.error("Audio error:",ee)),A(j,B)},H=j=>{var B=Gt(),se=x(B,!0);m(B),G(()=>ne(se,i(o).text)),A(j,B)};Y(D,j=>{i(o).audioData?j(L):j(H,!1)})}m(W),A(V,W)},z=V=>{var W=Ht(),D=x(W),L=x(D,!0);m(D);var H=R(D,2);m(W),G(()=>{ne(L,i(o).text),ae(H,"src",r())}),A(V,W)};Y(p,V=>{i(o).type==="server"?V(l):V(z,!1)})}m(d),G(()=>Te(d,`message-row ${i(o).type??""}`)),A(a,d)}),m(h);var M=R(h,2);{var J=a=>{var o=Zt(),d=x(o);je(d);var p=R(d,2);m(o),Ge(d,()=>i(b),l=>y(b,l)),q("keydown",d,l=>l.key==="Enter"&&g()),q("click",p,g),A(a,o)};Y(M,a=>{u()&&a(J)})}var C=R(M,2);{var F=a=>{var o=Xt();ce(o,5,s,oe,(d,p)=>{var l=Jt(),z=x(l,!0);m(l),G(()=>ne(z,i(p))),q("click",l,()=>k(i(p))),A(d,l)}),m(o),A(a,o)};Y(C,a=>{s().length>0&&a(F)})}var X=R(C,2);{var Z=a=>{var o=$t();ce(o,5,c,oe,(d,p)=>{var l=Qt(),z=x(l,!0);m(l),G(()=>ne(z,i(p))),q("click",l,()=>k(i(p))),A(d,l)}),m(o),A(a,o)};Y(X,a=>{c().length>0&&a(Z)})}m(U),A(t,U),he()}var nn=I('<img alt="User" class="avatar">'),rn=I('<div><div><div class="message-text"> </div> <!></div></div>'),sn=I('<div class="input-container"><input> <button>Send</button></div>'),an=I('<button class="response-button"> </button>'),on=I('<div class="buttons-container"></div>'),cn=I('<button class="action-button"> </button>'),ln=I('<div class="action-buttons-container"></div>'),un=I('<div class="container"><div class="messages-container"></div> <!> <!> <!></div>');function _n(t,e){we(e,!1);let n=P(e,"user",8),r=P(e,"avatarUrl",8),s=P(e,"sessionManager",8),c=P(e,"onAuthSuccess",8),u=O([]),f=O(""),S=O([]),E=O([]),w=O(!1);const _=new ArrayBuffer(0);let b=O();qe(async()=>{await v()});async function v(){try{const a=await le({user_id:n().id,username:n().username,user_first_name:n().first_name,user_last_name:n().last_name,action_step:me.LOGIN_START,session_data:_});await N(a)}catch(a){console.error("Error starting authentication:",a),y(u,[...i(u),{type:"server",text:"Error occurred during login. Please restart the application and try again."}])}}async function g(){if(!i(f).trim())return;y(u,[...i(u),{type:"user",text:i(b)===re.TwoFAPassRequest?"*".repeat(i(f).length):i(f)}]);const a=i(f);y(f,"");try{const o=await le({user_id:n().id,username:n().username,user_first_name:n().first_name,user_last_name:n().last_name,action:a,session_data:_});await N(o)}catch(o){console.error("Error handling input:",o)}}async function k(a){try{const o=await le({user_id:n().id,username:n().username,user_first_name:n().first_name,user_last_name:n().last_name,action:a,session_data:_});y(u,[...i(u),{type:"user",text:a}]),await N(o)}catch(o){console.error("Error handling button click:",o)}}async function N(a){if(y(u,[...i(u),{type:"server",text:a.message}]),y(S,a.buttons),y(E,a.action_buttons),y(w,a.can_input),y(b,a.stage),a.stage===re.AuthSuccess&&a.session_data)try{await s().save_session(BigInt(n().id),new Uint8Array(a.session_data)),console.log("Session saved successfully in IndexedDB"),c()(a)}catch(o){console.error("Error saving session:",o)}else if(a.stage===re.AuthError)try{await s().session_exists(BigInt(n().id))&&(await s().delete_session(BigInt(n().id)),console.log("Old session deleted due to auth error"))}catch(o){console.error("Error handling session deletion:",o)}}be();var U=un(),h=x(U);ce(h,5,()=>i(u),oe,(a,o)=>{var d=rn(),p=x(d),l=x(p),z=x(l,!0);m(l);var V=R(l,2);{var W=D=>{var L=nn();G(()=>ae(L,"src",r())),A(D,L)};Y(V,D=>{i(o).type==="user"&&D(W)})}m(p),m(d),G(()=>{Te(d,`message-row ${i(o).type??""}`),Te(p,`message ${i(o).type??""}-message`),ne(z,i(o).text)}),A(a,d)}),m(h);var M=R(h,2);{var J=a=>{var o=sn(),d=x(o);je(d);var p=R(d,2);m(o),G(()=>{ae(d,"type",i(b)===re.TwoFAPassRequest?"password":"text"),ae(d,"placeholder",i(b)===re.TwoFAPassRequest?"Enter your 2FA password...":"Enter your response...")}),Ge(d,()=>i(f),l=>y(f,l)),q("keydown",d,l=>l.key==="Enter"&&g()),q("click",p,g),A(a,o)};Y(M,a=>{i(w)&&a(J)})}var C=R(M,2);{var F=a=>{var o=on();ce(o,5,()=>i(S),oe,(d,p)=>{var l=an(),z=x(l,!0);m(l),G(()=>ne(z,i(p))),q("click",l,()=>k(i(p))),A(d,l)}),m(o),A(a,o)};Y(C,a=>{i(S).length>0&&a(F)})}var X=R(C,2);{var Z=a=>{var o=ln();ce(o,5,()=>i(E),oe,(d,p)=>{var l=cn(),z=x(l,!0);m(l),G(()=>ne(z,i(p))),q("click",l,()=>k(i(p))),A(d,l)}),m(o),A(a,o)};Y(X,a=>{i(E).length>0&&a(Z)})}m(U),A(t,U),he()}const dn=`Ваши данные в безопасности!

Мы используем принцип local-first, чтобы ваши данные оставались только под вашим контролем.
Это означает, что ключевые элементы вашей Telegram-сессии хранятся непосредственно на вашем устройстве.
Пароли и одноразовые коды не сохраняются и не логируются ни в каком виде.

Мы ценим ваше доверие и предлагаем полную прозрачность. Вы всегда можете ознакомиться с исходным кодом нашего приложения в открытом репозитории, чтобы лично убедиться в безопасности и надежности нашего подхода.`;var fn=I('<div class="modal-backdrop" role="dialog" aria-modal="true"><button class="backdrop-button" aria-label="Close modal overlay"></button> <div class="modal-content" role="document"><div class="modal-header"><button class="close-button" aria-label="Close modal">×</button></div> <div class="modal-body"><p></p></div></div></div>');function vn(t,e){we(e,!1);let n=P(e,"show",8),r=P(e,"onClose",8),s=O(!1);function c(){y(s,!0),setTimeout(()=>{y(s,!1),r()()},300)}function u(w){w.key==="Escape"&&c()}be();var f=Ee(),S=ie(f);{var E=w=>{var _=fn(),b=x(_),v=R(b,2),g=x(v),k=x(g);m(g);var N=R(g,2),U=x(N);U.textContent=dn,m(N),m(v),m(_),G(()=>zt(v,"closing",i(s))),q("click",b,c),q("keydown",b,u),q("click",k,c),A(w,_)};Y(S,w=>{n()&&w(E)})}A(t,f),he()}async function gn(t,e){try{if(!await t.session_exists(e))return console.log(`No session file found in IndexedDB for user: ${e}`),{success:!1};console.log(`Session file found in IndexedDB for user: ${e}`);const r=await t.get_session(e);return r?{success:!0,data:new Uint8Array(r).buffer}:(console.log(`Failed to extract session data from IndexedDB for user: ${e}`),{success:!1})}catch(n){return console.error(`Error extracting session data from IndexedDB: ${n}`),{success:!1}}}const bn={AVATARS:{TEST_USER:"https://i.ibb.co/DzMYg1f/alien-head-v2.webp",SERVER:"https://i.ibb.co/j8p2tmq/Pngtree-grey-dinosaur-cartoon-illustration-4653255.png"}};var wn=I(`<div class="header svelte-z6hshm"><h1 class="svelte-z6hshm">This is an authentication page</h1> <p class="svelte-z6hshm">Please provide the data you will be asked for to be logged-in<br>To be sure it's safe, check "Account security policy" at the main page of the App</p></div> <div class="auth-container svelte-z6hshm"><!></div>`,1),hn=I('<div class="header svelte-z6hshm"><h1 class="svelte-z6hshm">Welcome to <span class="viper-text svelte-z6hshm">the Viper room</span></h1> <p class="svelte-z6hshm">Your personal info wizard that keeps you always up to date</p></div> <div class="chat-container svelte-z6hshm"><!></div>',1),mn=I('<div class="buttons-container svelte-z6hshm"><div class="main-button-container svelte-z6hshm"><button class="login-button svelte-z6hshm">START</button></div> <div class="bottom-button-container svelte-z6hshm"><button class="policy-button svelte-z6hshm">account security<br>policy</button></div></div>'),yn=I('<p class="loading svelte-z6hshm">Loading...</p>'),pn=I('<div class="main-container svelte-z6hshm"><!></div> <!>',1);function Dn(t,e){we(e,!1);let n=O(null),r=O(null),s=O(!1),c=O(!1),u=bn.AVATARS.TEST_USER,f=O(),S=O(!1),E,w=O([]),_=O([]),b=O([]),v=O(!0);const g=new ArrayBuffer(0);qe(async()=>{await k(),console.log("Wasm module initialized");try{console.log("App mounted. Trying to initialize user..."),await N()}catch(l){console.error("Error initializing any user:",l)}});async function k(){await Ke(),y(f,new Ft),await i(f).initialize(),console.log("IndexedDB session manager initialized")}const N=async()=>{var l,z,V,W;try{let D,L;(W=(V=(z=(l=window.Telegram)==null?void 0:l.WebApp)==null?void 0:z.initDataUnsafe)==null?void 0:V.user)!=null&&W.id?(D=window.Telegram.WebApp.initDataUnsafe.user,L=await U(D.id),console.log("Telegram user initialized:",D)):(D={id:7543812650,username:"test_user",first_name:"Test",last_name:"User"},L=u,console.log("Test user initialized:",D)),y(n,D),y(r,L);const{success:H,data:j}=await gn(i(f),BigInt(i(n).id));if(!H){console.log(`Failed to extract ${i(n).username}'s session from IndexedDB. User must be logged in first`);return}const B=await le({user_id:i(n).id,username:i(n).username,user_first_name:i(n).first_name,user_last_name:i(n).last_name,action_step:me.MINI_APP_INITIALIZED,session_data:j||g});H&&B.stage===re.MiniAppInitConfirmed?(console.log("Telegram client is authorized and ready for use"),y(s,!0),y(w,[{type:"server",text:B.message}]),y(_,B.buttons),y(b,B.action_buttons),y(v,B.can_input),y(r,i(r))):(console.log("Telegram client is NOT authorized"),console.log("Server response:",B.message))}catch(D){console.error("Global error in initializing user fn:",D)}};async function U(l){return console.log("Fetching avatar url for user with id:",l),"https://i.ibb.co/j8p2tmq/Pngtree-grey-dinosaur-cartoon-illustration-4653255.png"}const h=()=>{y(c,!0)},M=l=>{y(c,!1),y(s,!0),y(w,[{type:"server",text:l.message}]),y(_,l.buttons),y(b,l.action_buttons),y(v,l.can_input)},J=()=>{y(s,!1)},C=()=>{y(S,!0)},F=()=>{y(S,!1)};be();var X=pn(),Z=ie(X),a=x(Z);{var o=l=>{var z=Ee(),V=ie(z);{var W=L=>{var H=wn(),j=R(ie(H),2),B=x(j);_n(B,{get user(){return i(n)},get avatarUrl(){return i(r)},get sessionManager(){return i(f)},onAuthSuccess:M}),m(j),A(L,H)},D=L=>{var H=Ee(),j=ie(H);{var B=Q=>{var $=hn(),ee=R(ie($),2),ye=x(ee);tn(ye,{get user(){return i(n)},get avatarUrl(){return i(r)},get messages(){return i(w)},get buttons(){return i(_)},get actionButtons(){return i(b)},get canInput(){return i(v)},sessionData:E,get sessionManager(){return i(f)},onSignOut:J}),m(ee),A(Q,$)},se=Q=>{var $=mn(),ee=x($),ye=x(ee);m(ee);var Ue=R(ee,2),Ze=x(Ue);m(Ue),m($),q("click",ye,h),q("click",Ze,C),A(Q,$)};Y(j,Q=>{i(s)?Q(B):Q(se,!1)},!0)}A(L,H)};Y(V,L=>{i(c)?L(W):L(D,!1)})}A(l,z)},d=l=>{var z=yn();A(l,z)};Y(a,l=>{i(n)?l(o):l(d,!1)})}m(Z);var p=R(Z,2);vn(p,{get show(){return i(S)},onClose:F}),A(t,X),he()}export{Dn as component,kn as universal};
