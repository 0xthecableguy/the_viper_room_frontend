var Ze=Object.defineProperty;var Je=(t,e,r)=>e in t?Ze(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var Ie=(t,e,r)=>Je(t,typeof e!="symbol"?e+"":e,r);import{a as A,t as U,c as xe}from"../chunks/disclose-version.DJaJJ7WK.js";import{i as be}from"../chunks/legacy.H8ha-IAe.js";import{m as K,M as ye,a5 as Xe,a4 as Qe,J as $e,i as et,I as tt,al as Ce,K as rt,L as ke,N as pe,o as ue,ah as nt,as as ge,O as Pe,j as Fe,P as st,F as De,at,au as ot,ak as it,av as ct,k as lt,a9 as ut,a2 as _t,A as Me,aw as dt,ax as ft,ay as vt,af as gt,az as bt,aA as wt,H as ht,aB as mt,aC as yt,b as pt,ao as St,p as we,v as x,g as o,w as y,t as V,x as L,s as he,C as p,aD as O,q as ae}from"../chunks/runtime.DD4oRMrK.js";import{a as At,l as xt,s as re,e as q}from"../chunks/render.BcBaRd89.js";import{p as P,i as Y}from"../chunks/props.Dab2Uh7G.js";import{a as Et,o as We}from"../chunks/index-client.ByK61EDX.js";function oe(t,e){return e}function Tt(t,e,r,n){for(var s=[],c=e.length,l=0;l<c;l++)ot(e[l].e,s,!0);var v=c>0&&s.length===0&&r!==null;if(v){var S=r.parentNode;it(S),S.append(r),n.clear(),te(t,e[0].prev,e[c-1].next)}ct(s,()=>{for(var E=0;E<c;E++){var h=e[E];v||(n.delete(h.k),te(t,h.prev,h.next)),lt(h.e,!v)}})}function ie(t,e,r,n,s,c=null){var l=t,v={flags:e,items:new Map,first:null};{var S=t;l=K?ye(Xe(S)):S.appendChild(Qe())}K&&$e();var E=null,h=!1;et(()=>{var _=r(),w=tt(_)?_:_==null?[]:Ce(_),g=w.length;if(h&&g===0)return;h=g===0;let b=!1;if(K){var D=l.data===rt;D!==(g===0)&&(l=ke(),ye(l),pe(!1),b=!0)}if(K){for(var B=null,I,m=0;m<g;m++){if(ue.nodeType===8&&ue.data===nt){l=ue,b=!0,pe(!1);break}var M=w[m],J=n(M,m);I=qe(ue,v,B,null,M,J,m,s,e),v.items.set(J,I),B=I}g>0&&ye(ke())}if(!K){var F=ut;Ut(w,v,l,s,e,(F.f&ge)!==0,n)}c!==null&&(g===0?E?Pe(E):E=Fe(()=>c(l)):E!==null&&st(E,()=>{E=null})),b&&pe(!0),r()}),K&&(l=ue)}function Ut(t,e,r,n,s,c,l,v){var S=t.length,E=e.items,h=e.first,_=h,w,g=null,b=[],D=[],B,I,m,M;for(M=0;M<S;M+=1){if(B=t[M],I=l(B,M),m=E.get(I),m===void 0){var J=_?_.e.nodes_start:r;g=qe(J,e,g,g===null?e.first:g.next,B,I,M,n,s),E.set(I,g),b=[],D=[],_=g.next;continue}if(It(m,B,M),m.e.f&ge&&Pe(m.e),m!==_){if(w!==void 0&&w.has(m)){if(b.length<D.length){var F=D[0],C;g=F.prev;var X=b[0],Q=b[b.length-1];for(C=0;C<b.length;C+=1)ze(b[C],F,r);for(C=0;C<D.length;C+=1)w.delete(D[C]);te(e,X.prev,Q.next),te(e,g,X),te(e,Q,F),_=F,g=Q,M-=1,b=[],D=[]}else w.delete(m),ze(m,_,r),te(e,m.prev,m.next),te(e,m,g===null?e.first:g.next),te(e,g,m),g=m;continue}for(b=[],D=[];_!==null&&_.k!==I;)(c||!(_.e.f&ge))&&(w??(w=new Set)).add(_),D.push(_),_=_.next;if(_===null)continue;m=_}b.push(m),g=m,_=m.next}if(_!==null||w!==void 0){for(var a=w===void 0?[]:Ce(w);_!==null;)(c||!(_.e.f&ge))&&a.push(_),_=_.next;var i=a.length;if(i>0){var d=S===0?r:null;Tt(e,a,d,E)}}De.first=e.first&&e.first.e,De.last=g&&g.e}function It(t,e,r,n){at(t.v,e),t.i=r}function qe(t,e,r,n,s,c,l,v,S,E){var h=(S&ft)!==0,_=(S&vt)===0,w=h?_?_t(s):Me(s):s,g=S&dt?Me(l):l,b={i:g,v:w,k:c,a:null,e:null,prev:r,next:n};try{return b.e=Fe(()=>v(t,w,g),K),b.e.prev=r&&r.e,b.e.next=n&&n.e,r===null?e.first=b:(r.next=b,r.e.next=b.e),n!==null&&(n.prev=b,n.e.prev=b.e),b}finally{}}function ze(t,e,r){for(var n=t.next?t.next.e.nodes_start:r,s=e?e.e.nodes_start:r,c=t.e.nodes_start;c!==n;){var l=gt(c);s.before(c),c=l}}function te(t,e,r){e===null?t.first=r:(e.next=r,e.e.next=r&&r.e),r!==null&&(r.prev=e,r.e.prev=e&&e.e)}function je(t){if(K){var e=!1,r=()=>{if(!e){if(e=!0,t.hasAttribute("value")){var n=t.value;se(t,"value",null),t.value=n}if(t.hasAttribute("checked")){var s=t.checked;se(t,"checked",null),t.checked=s}}};t.__on_r=r,bt(r),At()}}function se(t,e,r,n){var s=t.__attributes??(t.__attributes={});K&&(s[e]=t.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&t.nodeName==="LINK")||s[e]!==(s[e]=r)&&(e==="style"&&"__styles"in t&&(t.__styles={}),e==="loading"&&(t[wt]=r),r==null?t.removeAttribute(e):typeof r!="string"&&kt(t).includes(e)?t[e]=r:t.setAttribute(e,r))}var Ne=new Map;function kt(t){var e=Ne.get(t.nodeName);if(e)return e;Ne.set(t.nodeName,e=[]);for(var r,n=t,s=Element.prototype;s!==n;){r=mt(n);for(var c in r)r[c].set&&e.push(c);n=ht(n)}return e}function Ee(t,e,r){var n=t.__className,s=Dt(e);K&&t.className===s?t.__className=s:(n!==s||K&&t.className!==s)&&(e==null&&!r?t.removeAttribute("class"):t.className=s,t.__className=s)}function Dt(t,e){return(t??"")+""}function Mt(t,e,r){if(r){if(t.classList.contains(e))return;t.classList.add(e)}else{if(!t.classList.contains(e))return;t.classList.remove(e)}}function Ge(t,e,r=e){var n=yt();xt(t,"input",s=>{var c=s?t.defaultValue:t.value;if(c=Se(t)?Ae(c):c,r(c),n&&c!==(c=e())){var l=t.selectionStart,v=t.selectionEnd;t.value=c??"",v!==null&&(t.selectionStart=l,t.selectionEnd=Math.min(v,t.value.length))}}),(K&&t.defaultValue!==t.value||pt(e)==null&&t.value)&&r(Se(t)?Ae(t.value):t.value),St(()=>{var s=e();Se(t)&&s===Ae(t.value)||t.type==="date"&&!s&&!t.value||s!==t.value&&(t.value=s??"")})}function Se(t){var e=t.type;return e==="number"||e==="range"}function Ae(t){return t===""?null:+t}const zt=!0,Ir=Object.freeze(Object.defineProperty({__proto__:null,prerender:zt},Symbol.toStringTag,{value:"Module"}));class Nt{constructor(){Ie(this,"db",null)}async init(){return new Promise((e,r)=>{const n=indexedDB.open("UserData",1);n.onupgradeneeded=()=>{this.db=n.result,this.db.objectStoreNames.contains("userSessions")||this.db.createObjectStore("userSessions")},n.onsuccess=()=>{this.db=n.result,e()},n.onerror=()=>{console.error("Error opening IndexedDB:",n.error),r(n.error)}})}async saveSession(e,r){if(!this.db)throw new Error("Database is not initialized.");const n=this.db.transaction("userSessions","readwrite"),s=n.objectStore("userSessions");return new Promise((c,l)=>{s.put(r,e.toString()),n.oncomplete=()=>{console.log(`Session saved for user: ${e}`),c()},n.onerror=()=>{console.error("Error saving session:",n.error),l(n.error)}})}async getSession(e){if(!this.db)throw new Error("Database is not initialized.");const n=this.db.transaction("userSessions","readonly").objectStore("userSessions");return new Promise((s,c)=>{const l=n.get(e.toString());l.onsuccess=()=>{s(l.result||null)},l.onerror=()=>{console.error("Error loading session:",l.error),c(l.error)}})}async deleteSession(e){if(!this.db)throw new Error("Database is not initialized.");const r=this.db.transaction("userSessions","readwrite"),n=r.objectStore("userSessions");return new Promise((s,c)=>{n.delete(e.toString()),r.oncomplete=()=>{console.log(`Session deleted for user: ${e}`),s()},r.onerror=()=>{console.error("Error deleting session:",r.error),c(r.error)}})}async sessionExists(e){return await this.getSession(e)!==null}getDB(){if(!this.db)throw new Error("Database is not initialized");return this.db}}const _e=new Nt;typeof window<"u"&&(window.initDB=()=>_e.init(),window.saveUserSession=(t,e)=>{const r=e.buffer;return _e.saveSession(t,r)},window.getUserSession=t=>_e.getSession(t),window.deleteUserSession=t=>_e.deleteSession(t),window.checkSessionExists=t=>_e.sessionExists(t));let T;function de(t){const e=T.__externref_table_alloc();return T.__wbindgen_export_2.set(e,t),e}function Be(t,e){try{return t.apply(this,e)}catch(r){const n=de(r);T.__wbindgen_exn_store(n)}}const Ve=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&Ve.decode();let fe=null;function Te(){return(fe===null||fe.byteLength===0)&&(fe=new Uint8Array(T.memory.buffer)),fe}function Oe(t,e){return t=t>>>0,Ve.decode(Te().subarray(t,t+e))}function ve(t){return t==null}const Le=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>{T.__wbindgen_export_3.get(t.dtor)(t.a,t.b)});function Bt(t,e,r,n){const s={a:t,b:e,cnt:1,dtor:r},c=(...l)=>{s.cnt++;const v=s.a;s.a=0;try{return n(v,s.b,...l)}finally{--s.cnt===0?(T.__wbindgen_export_3.get(s.dtor)(v,s.b),Le.unregister(s)):s.a=v}};return c.original=s,Le.register(c,s,s),c}function Ot(t,e){return t=t>>>0,Te().subarray(t/1,t/1+e)}let Ye=0;function Lt(t,e){const r=e(t.length*1,1)>>>0;return Te().set(t,r/1),Ye=t.length,r}function Rt(t,e,r){T.closure20_externref_shim(t,e,r)}function Ct(t,e,r,n){T.closure41_externref_shim(t,e,r,n)}const Re=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>T.__wbg_sessionmanager_free(t>>>0,1));class Pt{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Re.unregister(this),e}free(){const e=this.__destroy_into_raw();T.__wbg_sessionmanager_free(e,0)}constructor(){const e=T.sessionmanager_new();return this.__wbg_ptr=e>>>0,Re.register(this,this.__wbg_ptr,this),this}initialize(){return T.sessionmanager_initialize(this.__wbg_ptr)}save_session(e,r){const n=Lt(r,T.__wbindgen_malloc),s=Ye;return T.sessionmanager_save_session(this.__wbg_ptr,e,n,s)}get_session(e){return T.sessionmanager_get_session(this.__wbg_ptr,e)}delete_session(e){return T.sessionmanager_delete_session(this.__wbg_ptr,e)}session_exists(e){return T.sessionmanager_session_exists(this.__wbg_ptr,e)}}async function Ft(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(n){if(t.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n);else throw n}const r=await t.arrayBuffer();return await WebAssembly.instantiate(r,e)}else{const r=await WebAssembly.instantiate(t,e);return r instanceof WebAssembly.Instance?{instance:r,module:t}:r}}function Wt(){const t={};return t.wbg={},t.wbg.__wbg_buffer_61b7ce01341d7f88=function(e){return e.buffer},t.wbg.__wbg_call_500db948e69c7330=function(){return Be(function(e,r,n){return e.call(r,n)},arguments)},t.wbg.__wbg_call_b0d8e36992d9900d=function(){return Be(function(e,r){return e.call(r)},arguments)},t.wbg.__wbg_checkSessionExists_340e16b697e915bf=function(e){return checkSessionExists(BigInt.asUintN(64,e))},t.wbg.__wbg_deleteUserSession_36cd7b326cd4514a=function(e){return deleteUserSession(BigInt.asUintN(64,e))},t.wbg.__wbg_getUserSession_e0f134950e9904c6=function(e){return getUserSession(BigInt.asUintN(64,e))},t.wbg.__wbg_initDB_5ef5f7eaea3713b7=function(){return initDB()},t.wbg.__wbg_length_65d1cd11729ced11=function(e){return e.length},t.wbg.__wbg_new_3d446df9155128ef=function(e,r){try{var n={a:e,b:r},s=(l,v)=>{const S=n.a;n.a=0;try{return Ct(S,n.b,l,v)}finally{n.a=S}};return new Promise(s)}finally{n.a=n.b=0}},t.wbg.__wbg_new_3ff5b33b1ce712df=function(e){return new Uint8Array(e)},t.wbg.__wbg_newnoargs_fd9e4bf8be2bc16d=function(e,r){return new Function(Oe(e,r))},t.wbg.__wbg_newwithbyteoffsetandlength_ba35896968751d91=function(e,r,n){return new Uint8Array(e,r>>>0,n>>>0)},t.wbg.__wbg_newwithlength_34ce8f1051e74449=function(e){return new Uint8Array(e>>>0)},t.wbg.__wbg_queueMicrotask_2181040e064c0dc8=function(e){queueMicrotask(e)},t.wbg.__wbg_queueMicrotask_ef9ac43769cbcc4f=function(e){return e.queueMicrotask},t.wbg.__wbg_resolve_0bf7c44d641804f9=function(e){return Promise.resolve(e)},t.wbg.__wbg_saveUserSession_0686280def1dddff=function(e,r){return saveUserSession(BigInt.asUintN(64,e),r)},t.wbg.__wbg_set_23d69db4e5c66a6e=function(e,r,n){e.set(r,n>>>0)},t.wbg.__wbg_static_accessor_GLOBAL_0be7472e492ad3e3=function(){const e=typeof global>"u"?null:global;return ve(e)?0:de(e)},t.wbg.__wbg_static_accessor_GLOBAL_THIS_1a6eb482d12c9bfb=function(){const e=typeof globalThis>"u"?null:globalThis;return ve(e)?0:de(e)},t.wbg.__wbg_static_accessor_SELF_1dc398a895c82351=function(){const e=typeof self>"u"?null:self;return ve(e)?0:de(e)},t.wbg.__wbg_static_accessor_WINDOW_ae1c80c7eea8d64a=function(){const e=typeof window>"u"?null:window;return ve(e)?0:de(e)},t.wbg.__wbg_then_0438fad860fe38e1=function(e,r){return e.then(r)},t.wbg.__wbg_then_0ffafeddf0e182a4=function(e,r,n){return e.then(r,n)},t.wbg.__wbindgen_boolean_get=function(e){const r=e;return typeof r=="boolean"?r?1:0:2},t.wbg.__wbindgen_cb_drop=function(e){const r=e.original;return r.cnt--==1?(r.a=0,!0):!1},t.wbg.__wbindgen_closure_wrapper80=function(e,r,n){return Bt(e,r,21,Rt)},t.wbg.__wbindgen_init_externref_table=function(){const e=T.__wbindgen_export_2,r=e.grow(4);e.set(0,void 0),e.set(r+0,void 0),e.set(r+1,null),e.set(r+2,!0),e.set(r+3,!1)},t.wbg.__wbindgen_is_function=function(e){return typeof e=="function"},t.wbg.__wbindgen_is_null=function(e){return e===null},t.wbg.__wbindgen_is_undefined=function(e){return e===void 0},t.wbg.__wbindgen_memory=function(){return T.memory},t.wbg.__wbindgen_throw=function(e,r){throw new Error(Oe(e,r))},t.wbg.__wbindgen_uint8_array_new=function(e,r){var n=Ot(e,r).slice();return T.__wbindgen_free(e,r*1,1),n},t}function qt(t,e){return T=t.exports,He.__wbindgen_wasm_module=e,fe=null,T.__wbindgen_start(),T}async function He(t){if(T!==void 0)return T;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof t>"u"&&(t=new URL(""+new URL("../assets/wizard_pi_wasm_bg.CxENxoTU.wasm",import.meta.url).href,import.meta.url));const e=Wt();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:r,module:n}=await Ft(await t,e);return qt(r,n)}const ce=async t=>{console.log("Sending request payload to server:",t);const e={...t,session_data:Array.from(new Uint8Array(t.session_data))},r=await fetch("https://v3.spb.ru/wizard_pi_user_action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(console.log("Server response status:",r.status),!r.ok)throw new Error("Network Error");const n=await r.json();return console.log("Server response data:",n),n},jt=async t=>{try{const e=await fetch(`https://v3.spb.ru/get_user_avatar?user_id=${t}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(console.log("Fetching avatar URL:",`https://v3.spb.ru/get_user_avatar?user_id=${t}`),console.log("Avatar fetch server response status:",e.status),!e.ok)throw new Error("Failed to fetch avatar");return(await e.json()).avatar_url||null}catch(e){return console.error("Error fetching avatar:",e),null}};var me=(t=>(t.MINI_APP_INITIALIZED="MINI_APP_INITIALIZED",t.LOGIN_START="LOGIN_START",t.SIGN_OUT="SIGN_OUT",t))(me||{}),ne=(t=>(t.TwoFAPassRequest="TwoFAPassRequest",t.AuthSuccess="AuthSuccess",t.AuthError="AuthError",t.SignedOut="SignedOut",t.MiniAppInitConfirmed="MiniAppInitConfirmed",t))(ne||{}),Gt=U('<div class="audio-message"><audio controls>Your browser does not support the audio element.</audio> <div class="message-text"> </div></div>'),Vt=U('<div class="message-text"> </div>'),Yt=U('<div class="message server-message"><!></div>'),Ht=U('<div class="message user-message"><div class="message-text"> </div> <img alt="User" class="avatar"></div>'),Kt=U("<div><!></div>"),Zt=U('<div class="input-container"><input type="text" placeholder="Type your message..."> <button>SEND</button></div>'),Jt=U('<button class="response-button"> </button>'),Xt=U('<div class="buttons-container"></div>'),Qt=U('<button class="action-button"> </button>'),$t=U('<div class="action-buttons-container"></div>'),er=U('<div class="container"><div class="messages-container"></div> <!> <!> <!></div>');function tr(t,e){we(e,!1);let r=P(e,"user",8),n=P(e,"avatarUrl",12),s=P(e,"buttons",12),c=P(e,"actionButtons",12),l=P(e,"canInput",12),v=P(e,"sessionData",8),S=P(e,"sessionManager",8),E=P(e,"onSignOut",8),h=P(e,"messages",12),_=[],w=O("");const g=new ArrayBuffer(0);async function b(){if(o(w).trim()){h([...h(),{type:"user",text:o(w)}]);try{const a=await ce({user_id:r().id,username:r().username,user_first_name:r().first_name,user_last_name:r().last_name,action:o(w),session_data:v()||g});h([...h(),{type:"server",text:a.message}]),s(a.buttons),c(a.action_buttons),l(a.can_input),n(n()),p(w,"")}catch(a){console.error("Error sending message:",a),h([...h(),{type:"server",text:"Error sending message to server"}])}}}async function D(a){try{const i=a==="Sign out"?{user_id:r().id,username:r().username,user_first_name:r().first_name,user_last_name:r().last_name,action_step:me.SIGN_OUT,session_data:v()||g}:{user_id:r().id,username:r().username,user_first_name:r().first_name,user_last_name:r().last_name,action:a,session_data:v()||g},d=await ce(i);if(h([...h(),{type:"user",text:a},{type:"server",text:d.message,audioData:d.audio_data}]),s(d.buttons),c(d.action_buttons),l(d.can_input),d.stage===ne.SignedOut)try{await S().session_exists(BigInt(r().id))&&(await S().delete_session(BigInt(r().id)),console.log("Session successfully deleted after sign-out command from user"),E()())}catch(u){console.error("Error handling session deletion after sign-out command from user:",u)}}catch(i){console.error("Error handling button click:",i)}}function B(a){try{const i=new Uint8Array(a),d=new Blob([i.buffer],{type:"audio/mpeg"}),u=URL.createObjectURL(d);return _.push(u),console.log("Audio URL created:",u),console.log("Audio data size:",i.length),u}catch(i){return console.error("Error creating audio URL:",i),""}}Et(()=>{_.forEach(a=>URL.revokeObjectURL(a))}),be();var I=er(),m=x(I);ie(m,5,h,oe,(a,i)=>{var d=Kt(),u=x(d);{var f=j=>{var W=Yt(),z=x(W);{var k=G=>{var Z=Gt(),N=x(Z);V(()=>se(N,"src",B(o(i).audioData)));var $=L(N,2),ee=x($,!0);y($),y(Z),V(()=>re(ee,o(i).text)),q("error",N,le=>console.error("Audio error:",le)),A(G,Z)},H=G=>{var Z=Vt(),N=x(Z,!0);y(Z),V(()=>re(N,o(i).text)),A(G,Z)};Y(z,G=>{o(i).audioData?G(k):G(H,!1)})}y(W),A(j,W)},R=j=>{var W=Ht(),z=x(W),k=x(z,!0);y(z);var H=L(z,2);y(W),V(()=>{re(k,o(i).text),se(H,"src",n())}),A(j,W)};Y(u,j=>{o(i).type==="server"?j(f):j(R,!1)})}y(d),V(()=>Ee(d,`message-row ${o(i).type??""}`)),A(a,d)}),y(m);var M=L(m,2);{var J=a=>{var i=Zt(),d=x(i);je(d);var u=L(d,2);y(i),Ge(d,()=>o(w),f=>p(w,f)),q("keydown",d,f=>f.key==="Enter"&&b()),q("click",u,b),A(a,i)};Y(M,a=>{l()&&a(J)})}var F=L(M,2);{var C=a=>{var i=Xt();ie(i,5,s,oe,(d,u)=>{var f=Jt(),R=x(f,!0);y(f),V(()=>re(R,o(u))),q("click",f,()=>D(o(u))),A(d,f)}),y(i),A(a,i)};Y(F,a=>{s().length>0&&a(C)})}var X=L(F,2);{var Q=a=>{var i=$t();ie(i,5,c,oe,(d,u)=>{var f=Qt(),R=x(f,!0);y(f),V(()=>re(R,o(u))),q("click",f,()=>D(o(u))),A(d,f)}),y(i),A(a,i)};Y(X,a=>{c().length>0&&a(Q)})}y(I),A(t,I),he()}var rr=U('<img alt="User" class="avatar">'),nr=U('<div><div><div class="message-text"> </div> <!></div></div>'),sr=U('<div class="input-container"><input> <button>Send</button></div>'),ar=U('<button class="response-button"> </button>'),or=U('<div class="buttons-container"></div>'),ir=U('<button class="action-button"> </button>'),cr=U('<div class="action-buttons-container"></div>'),lr=U('<div class="container"><div class="messages-container"></div> <!> <!> <!></div>');function ur(t,e){we(e,!1);let r=P(e,"user",8),n=P(e,"avatarUrl",8),s=P(e,"sessionManager",8),c=P(e,"onAuthSuccess",8),l=O([]),v=O(""),S=O([]),E=O([]),h=O(!1);const _=new ArrayBuffer(0);let w=O();We(async()=>{await g()});async function g(){try{const a=await ce({user_id:r().id,username:r().username,user_first_name:r().first_name,user_last_name:r().last_name,action_step:me.LOGIN_START,session_data:_});await B(a)}catch(a){console.error("Error starting authentication:",a),p(l,[...o(l),{type:"server",text:"Error occurred during login. Please restart the application and try again."}])}}async function b(){if(!o(v).trim())return;p(l,[...o(l),{type:"user",text:o(w)===ne.TwoFAPassRequest?"*".repeat(o(v).length):o(v)}]);const a=o(v);p(v,"");try{const i=await ce({user_id:r().id,username:r().username,user_first_name:r().first_name,user_last_name:r().last_name,action:a,session_data:_});await B(i)}catch(i){console.error("Error handling input:",i)}}async function D(a){try{const i=await ce({user_id:r().id,username:r().username,user_first_name:r().first_name,user_last_name:r().last_name,action:a,session_data:_});p(l,[...o(l),{type:"user",text:a}]),await B(i)}catch(i){console.error("Error handling button click:",i)}}async function B(a){if(p(l,[...o(l),{type:"server",text:a.message}]),p(S,a.buttons),p(E,a.action_buttons),p(h,a.can_input),p(w,a.stage),a.stage===ne.AuthSuccess&&a.session_data)try{await s().save_session(BigInt(r().id),new Uint8Array(a.session_data)),console.log("Session saved successfully in IndexedDB"),c()(a)}catch(i){console.error("Error saving session:",i)}else if(a.stage===ne.AuthError)try{await s().session_exists(BigInt(r().id))&&(await s().delete_session(BigInt(r().id)),console.log("Old session deleted due to auth error"))}catch(i){console.error("Error handling session deletion:",i)}}be();var I=lr(),m=x(I);ie(m,5,()=>o(l),oe,(a,i)=>{var d=nr(),u=x(d),f=x(u),R=x(f,!0);y(f);var j=L(f,2);{var W=z=>{var k=rr();V(()=>se(k,"src",n())),A(z,k)};Y(j,z=>{o(i).type==="user"&&z(W)})}y(u),y(d),V(()=>{Ee(d,`message-row ${o(i).type??""}`),Ee(u,`message ${o(i).type??""}-message`),re(R,o(i).text)}),A(a,d)}),y(m);var M=L(m,2);{var J=a=>{var i=sr(),d=x(i);je(d);var u=L(d,2);y(i),V(()=>{se(d,"type",o(w)===ne.TwoFAPassRequest?"password":"text"),se(d,"placeholder",o(w)===ne.TwoFAPassRequest?"Enter your 2FA password...":"Enter your response...")}),Ge(d,()=>o(v),f=>p(v,f)),q("keydown",d,f=>f.key==="Enter"&&b()),q("click",u,b),A(a,i)};Y(M,a=>{o(h)&&a(J)})}var F=L(M,2);{var C=a=>{var i=or();ie(i,5,()=>o(S),oe,(d,u)=>{var f=ar(),R=x(f,!0);y(f),V(()=>re(R,o(u))),q("click",f,()=>D(o(u))),A(d,f)}),y(i),A(a,i)};Y(F,a=>{o(S).length>0&&a(C)})}var X=L(F,2);{var Q=a=>{var i=cr();ie(i,5,()=>o(E),oe,(d,u)=>{var f=ir(),R=x(f,!0);y(f),V(()=>re(R,o(u))),q("click",f,()=>D(o(u))),A(d,f)}),y(i),A(a,i)};Y(X,a=>{o(E).length>0&&a(Q)})}y(I),A(t,I),he()}const _r=`Ваши данные в безопасности!

Мы используем принцип local-first, чтобы ваши данные оставались только под вашим контролем.
Это означает, что ключевые элементы вашей Telegram-сессии хранятся непосредственно на вашем устройстве.
Пароли и одноразовые коды не сохраняются и не логируются ни в каком виде.

Мы ценим ваше доверие и предлагаем полную прозрачность. Вы всегда можете ознакомиться с исходным кодом нашего приложения в открытом репозитории, чтобы лично убедиться в безопасности и надежности нашего подхода.`;var dr=U('<div class="modal-backdrop" role="dialog" aria-modal="true"><button class="backdrop-button" aria-label="Close modal overlay"></button> <div class="modal-content" role="document"><div class="modal-header"><button class="close-button" aria-label="Close modal">×</button></div> <div class="modal-body"><p></p></div></div></div>');function fr(t,e){we(e,!1);let r=P(e,"show",8),n=P(e,"onClose",8),s=O(!1);function c(){p(s,!0),setTimeout(()=>{p(s,!1),n()()},300)}function l(h){h.key==="Escape"&&c()}be();var v=xe(),S=ae(v);{var E=h=>{var _=dr(),w=x(_),g=L(w,2),b=x(g),D=x(b);y(b);var B=L(b,2),I=x(B);I.textContent=_r,y(B),y(g),y(_),V(()=>Mt(g,"closing",o(s))),q("click",w,c),q("keydown",w,l),q("click",D,c),A(h,_)};Y(S,h=>{r()&&h(E)})}A(t,v),he()}async function vr(t,e){try{if(!await t.session_exists(e))return console.log(`No session file found in IndexedDB for user: ${e}`),{success:!1};console.log(`Session file found in IndexedDB for user: ${e}`);const n=await t.get_session(e);return n?{success:!0,data:new Uint8Array(n).buffer}:(console.log(`Failed to extract session data from IndexedDB for user: ${e}`),{success:!1})}catch(r){return console.error(`Error extracting session data from IndexedDB: ${r}`),{success:!1}}}const gr={AVATARS:{TEST_USER:"https://i.ibb.co/DzMYg1f/alien-head-v2.webp",SERVER:"https://i.ibb.co/j8p2tmq/Pngtree-grey-dinosaur-cartoon-illustration-4653255.png"}};var br=U(`<div class="header svelte-z6hshm"><h1 class="svelte-z6hshm">This is an authentication page</h1> <p class="svelte-z6hshm">Please provide the data you will be asked for to be logged-in<br>To be sure it's safe, check "Account security policy" at the main page of the App</p></div> <div class="auth-container svelte-z6hshm"><!></div>`,1),wr=U('<div class="header svelte-z6hshm"><h1 class="svelte-z6hshm">Welcome to <span class="viper-text svelte-z6hshm">the Viper room</span></h1> <p class="svelte-z6hshm">Your personal info wizard that keeps you always up to date</p></div> <div class="chat-container svelte-z6hshm"><!></div>',1),hr=U('<div class="buttons-container svelte-z6hshm"><div class="main-button-container svelte-z6hshm"><button class="login-button svelte-z6hshm">START</button></div> <div class="bottom-button-container svelte-z6hshm"><button class="policy-button svelte-z6hshm">account security<br>policy</button></div></div>'),mr=U('<p class="loading svelte-z6hshm">Loading...</p>'),yr=U('<div class="main-container svelte-z6hshm"><!></div> <!>',1);function kr(t,e){we(e,!1);let r=O(null),n=O(null),s=O(!1),c=O(!1),l=gr.AVATARS.TEST_USER,v=O(),S=O(!1),E,h=O([]),_=O([]),w=O([]),g=O(!0);const b=new ArrayBuffer(0);We(async()=>{await D(),console.log("Wasm module initialized");try{console.log("App mounted. Trying to initialize user..."),await B()}catch(u){console.error("Error initializing any user:",u)}});async function D(){await He(),p(v,new Pt),await o(v).initialize(),console.log("IndexedDB session manager initialized")}const B=async()=>{var u,f,R,j,W,z;try{let k,H;(j=(R=(f=(u=window.Telegram)==null?void 0:u.WebApp)==null?void 0:f.initDataUnsafe)==null?void 0:R.user)!=null&&j.id?(k=window.Telegram.WebApp.initDataUnsafe.user,H=await jt(k.id),console.log("Telegram user initialized:",k)):(console.log("initDataUnsafe:",(z=(W=window.Telegram)==null?void 0:W.WebApp)==null?void 0:z.initDataUnsafe),k={id:7543812650,username:"test_user",first_name:"Test",last_name:"User"},H=l,console.log("Test user initialized:",k)),p(r,k),p(n,H);const{success:G,data:Z}=await vr(o(v),BigInt(o(r).id));if(!G){console.log(`Failed to extract ${o(r).username}'s session from IndexedDB. User must be logged in first`);return}const N=await ce({user_id:o(r).id,username:o(r).username,user_first_name:o(r).first_name,user_last_name:o(r).last_name,action_step:me.MINI_APP_INITIALIZED,session_data:Z||b});G&&N.stage===ne.MiniAppInitConfirmed?(console.log("Telegram client is authorized and ready for use"),p(s,!0),p(h,[{type:"server",text:N.message}]),p(_,N.buttons),p(w,N.action_buttons),p(g,N.can_input),p(n,o(n))):(console.log("Telegram client is NOT authorized"),console.log("Server response:",N.message))}catch(k){console.error("Global error in initializing user fn:",k)}},I=()=>{p(c,!0)},m=u=>{p(c,!1),p(s,!0),p(h,[{type:"server",text:u.message}]),p(_,u.buttons),p(w,u.action_buttons),p(g,u.can_input)},M=()=>{p(s,!1)},J=()=>{p(S,!0)},F=()=>{p(S,!1)};be();var C=yr(),X=ae(C),Q=x(X);{var a=u=>{var f=xe(),R=ae(f);{var j=z=>{var k=br(),H=L(ae(k),2),G=x(H);ur(G,{get user(){return o(r)},get avatarUrl(){return o(n)},get sessionManager(){return o(v)},onAuthSuccess:m}),y(H),A(z,k)},W=z=>{var k=xe(),H=ae(k);{var G=N=>{var $=wr(),ee=L(ae($),2),le=x(ee);tr(le,{get user(){return o(r)},get avatarUrl(){return o(n)},get messages(){return o(h)},get buttons(){return o(_)},get actionButtons(){return o(w)},get canInput(){return o(g)},sessionData:E,get sessionManager(){return o(v)},onSignOut:M}),y(ee),A(N,$)},Z=N=>{var $=hr(),ee=x($),le=x(ee);y(ee);var Ue=L(ee,2),Ke=x(Ue);y(Ue),y($),q("click",le,I),q("click",Ke,J),A(N,$)};Y(H,N=>{o(s)?N(G):N(Z,!1)},!0)}A(z,k)};Y(R,z=>{o(c)?z(j):z(W,!1)})}A(u,f)},i=u=>{var f=mr();A(u,f)};Y(Q,u=>{o(r)?u(a):u(i,!1)})}y(X);var d=L(X,2);fr(d,{get show(){return o(S)},onClose:F}),A(t,C),he()}export{kr as component,Ir as universal};
